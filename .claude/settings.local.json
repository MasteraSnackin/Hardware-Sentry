{
  "permissions": {
    "allow": [
      "Bash(dir:*)",
      "Bash(npm run type-check:*)",
      "Bash(timeout 8 npm run dev:*)",
      "Bash(npm run build:*)",
      "Bash(git remote add:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(vercel:*)",
      "Bash(VERCEL_ORG_ID=team_04Gye9iCf6HxjdYr4lHM5WbK vercel deploy:*)",
      "Bash(curl:*)",
      "Bash(git pull:*)",
      "Bash(\"c:\\\\Users\\\\first\\\\Desktop\\\\Hardware Sentry\\\\BUILDER.md\" << 'EOF'\n# BUILDER.md ‚Äî Application Functionality & Logic Protocol\n\n**Role:** Backend Engineer & Performance Specialist  \n**Mission:** Build the \"engine\" of the application with reliability, performance, and scalability  \n**Lane:** `/backend`, `/api`, `/lib`, serverless configuration\n\n---\n\n## üéØ Core Responsibilities\n\n### Primary Focus\n1. **API Routes** ‚Äî Design and implement serverless endpoints\n2. **Business Logic** ‚Äî Core application functionality and data processing\n3. **Performance** ‚Äî Optimization, caching, and response times\n4. **Reliability** ‚Äî Error handling, retries, circuit breakers\n5. **Infrastructure** ‚Äî Serverless configuration, deployment, monitoring\n\n### Deliverables\n- Production-ready API endpoints\n- Efficient data processing pipelines\n- Robust error handling and recovery\n- Performance monitoring and metrics\n- Updated PLAN.md documentation\n\n---\n\n## üö´ Prohibitions\n\n**DO NOT:**\n- Touch CSS, styling, or visual layouts\n- Modify component aesthetics or animations\n- Change UI/UX design decisions\n- Add or remove visual elements\n- Adjust colors, fonts, or spacing\n\n**Your Lane:**\n- `/src/app/api/` ‚Äî API route handlers\n- `/src/lib/` ‚Äî Core business logic libraries\n- `/serverless/` ‚Äî Serverless function configs\n- `vercel.json` ‚Äî Deployment configuration\n- `PLAN.md` ‚Äî Backend architecture documentation\n\n**Leave to Design Lead:**\n- `/src/components/` ‚Äî Component styling\n- `/src/app/globals.css` ‚Äî Visual styles\n- Framer Motion animations\n- Theme configuration\n- Layout and spacing\n\n---\n\n## üìã Builder Workflow\n\n### Phase 1: Analysis & Planning\n\n**Step 1: Read Current State**\n```bash\n# Review existing backend architecture\ncat PLAN.md\n\n# Check API structure\nls -la src/app/api/\n\n# Review core libraries\nls -la src/lib/\n```\n\n**Step 2: Identify Gaps**\n- Missing endpoints?\n- Performance bottlenecks?\n- Error handling issues?\n- Scalability concerns?\n- Monitoring blind spots?\n\n**Step 3: Prioritize Tasks**\nCreate a prioritized list in PLAN.md:\n```markdown\n## Phase N: [Feature Category]\n\n### üéØ Priority 1: [Feature Name]\n**Problem:** [What's broken or missing]\n**Solution:** [How to fix it]\n**Impact:** [Expected improvement with metrics]\n**ETA:** [Time estimate]\n```\n\n---\n\n### Phase 2: Implementation\n\n**Step 1: Create Feature Branch \\(Optional\\)**\n```bash\ngit checkout -b feature/circuit-breaker\n```\n\n**Step 2: Implement in Order**\n1. **Layer 3 \\(Execution\\)** ‚Äî Pure functions in `/src/lib/`\n2. **Layer 2 \\(Orchestration\\)** ‚Äî API routes in `/src/app/api/`\n3. **Layer 1 \\(Directives\\)** ‚Äî Documentation in `/directives/`\n\n**Step 3: Follow Best Practices**\n\n**Error Handling Pattern:**\n```typescript\ntry {\n  const result = await operation\\(\\);\n  return NextResponse.json\\(result\\);\n} catch \\(error\\) {\n  // Try fallback \\(cached data\\)\n  if \\(cachedData\\) {\n    return NextResponse.json\\({ ...cachedData, stale: true }\\);\n  }\n  // No fallback available\n  return NextResponse.json\\(\n    { error: error instanceof Error ? error.message : 'Unknown error' },\n    { status: 500 }\n  \\);\n}\n```\n\n**TypeScript Strict Mode:**\n```typescript\n// Always validate unknown types\nexport function validate\\(result: unknown\\): result is Type {\n  return \\(\n    typeof result === 'object' &&\n    result !== null &&\n    'key' in result &&\n    typeof result.key === 'string'\n  \\);\n}\n```\n\n**Performance Monitoring:**\n```typescript\nconst monitor = new PerformanceMonitor\\('POST /api/endpoint'\\);\n// ... operation ...\nmonitor.end\\(true, { metric: value }\\);\nreturn createMonitoredResponse\\(monitor, data, metadata\\);\n```\n\n---\n\n### Phase 3: Testing & Validation\n\n**Step 1: Type Check**\n```bash\nnpm run type-check\n```\n\n**Step 2: Lint**\n```bash\nnpm run lint\n```\n\n**Step 3: Build**\n```bash\nnpm run build\n```\n\n**Step 4: Manual Testing**\n```bash\n# Start dev server\nnpm run dev\n\n# Test endpoint\ncurl -X POST http://localhost:3000/api/endpoint \\\\\n  -H \"Content-Type: application/json\" \\\\\n  -d '{\"key\": \"value\"}'\n```\n\n**Step 5: Health Check**\n```bash\ncurl http://localhost:3000/api/health\n```\n\n---\n\n### Phase 4: Documentation & Deployment\n\n**Step 1: Update PLAN.md**\n```markdown\n## ‚úÖ Phase N: [Feature Category] \\(COMPLETE\\)\n\n### üéØ [Feature Name]\n**Status:** ‚úÖ **COMPLETE** - `path/to/file.ts` created and tested\n**Impact:** [Actual measured improvement]\n```\n\n**Step 2: Update Performance Metrics**\n```markdown\n| Metric | Target | Current | Status |\n|--------|--------|---------|--------|\n| API Response Time | <3s | ~2s | ‚úÖ |\n| Error Rate | <5% | <2% | ‚úÖ |\n```\n\n**Step 3: Commit Changes**\n```bash\ngit add .\ngit commit -m \"feat: Add [feature] with [impact]\n\n- Created [files]\n- Modified [files]\n- Impact: [metrics]\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\"\n```\n\n**Step 4: Deploy \\(if ready\\)**\n```bash\nvercel --prod\n```\n\n---\n\n## üèóÔ∏è Architecture Principles\n\n### 3-Layer System\n\n**Layer 1: Directives \\(What to do\\)**\n- SOP documents in `directives/*.md`\n- Define goals, inputs, expected outputs\n- Example: `directives/scan_hardware.md`\n\n**Layer 2: Orchestration \\(Decision making\\)**\n- API routes in `src/app/api/*`\n- Read configs, make decisions, coordinate services\n- Handle routing and error recovery\n\n**Layer 3: Execution \\(Doing the work\\)**\n- Pure functions in `src/lib/*`\n- Deterministic operations only\n- No side effects, easy to test\n\n**Rationale:**\n- AI systems \\(Layer 1\\) are probabilistic\n- Business logic \\(Layer 3\\) must be deterministic\n- Separation prevents error compounding\n\n---\n\n## üìä Performance Standards\n\n### Response Times\n- **Health check:** < 100ms\n- **Cache hit:** < 500ms\n- **API call:** < 3s\n- **Batch operation:** < 10s\n\n### Reliability\n- **Uptime:** > 99.5%\n- **Error rate:** < 5%\n- **Retry success:** > 80%\n- **Cache hit ratio:** > 60%\n\n### Scalability\n- **Concurrent users:** 50+\n- **Requests/second:** 10+\n- **Cold start:** < 2s\n\n---\n\n## üõ†Ô∏è Common Patterns\n\n### Retry with Exponential Backoff\n```typescript\nimport { withRetry } from '@/lib/retry';\n\nconst result = await withRetry\\(\n  async \\(\\) => await apiCall\\(\\),\n  {\n    maxAttempts: 3,\n    baseDelay: 2000,\n    maxDelay: 8000,\n  }\n\\);\n```\n\n### Circuit Breaker Protection\n```typescript\nimport { circuitBreaker } from '@/lib/circuitBreaker';\n\nconst result = await circuitBreaker.execute\\(async \\(\\) => {\n  return await externalAPI\\(\\);\n}\\);\n```\n\n### Rate Limiting\n```typescript\nimport { applyRateLimit } from '@/lib/middleware';\n\nexport async function POST\\(request: NextRequest\\) {\n  const rateLimitResponse = applyRateLimit\\(request\\);\n  if \\(rateLimitResponse\\) return rateLimitResponse;\n  // ... continue with logic\n}\n```\n\n### Performance Monitoring\n```typescript\nimport { PerformanceMonitor } from '@/lib/middleware';\n\nconst monitor = new PerformanceMonitor\\('POST /api/scan'\\);\n// ... operation ...\nmonitor.end\\(true, { sku, vendors: 4 }\\);\nreturn createMonitoredResponse\\(monitor, data\\);\n```\n\n### Distributed Locking\n```typescript\nimport { acquireScanLock, releaseScanLock } from '@/lib/redis';\n\nconst lockAcquired = await acquireScanLock\\(sku\\);\nif \\(!lockAcquired\\) {\n  return NextResponse.json\\({ error: 'Scan in progress' }, { status: 429 }\\);\n}\n\ntry {\n  // ... critical section ...\n} finally {\n  await releaseScanLock\\(sku\\);\n}\n```\n\n---\n\n## üöÄ Phase Templates\n\n### Phase 1: Core Infrastructure\nFocus: Essential backend features for MVP\n\n**Typical Tasks:**\n- API endpoint scaffolding\n- Database/cache setup\n- Basic error handling\n- Environment configuration\n- Health checks\n\n### Phase 2: Performance & Reliability\nFocus: Production-ready optimizations\n\n**Typical Tasks:**\n- Retry logic\n- Circuit breakers\n- Rate limiting\n- Response compression\n- Performance monitoring\n\n### Phase 3: Advanced Features\nFocus: Enhanced functionality and scale\n\n**Typical Tasks:**\n- Batch operations\n- Webhook notifications\n- Analytics endpoints\n- Advanced caching\n- Distributed systems\n\n---\n\n## üìù Checklist \\(Before Completion\\)\n\n**Code Quality:**\n- [ ] TypeScript strict mode passing\n- [ ] ESLint warnings resolved or justified\n- [ ] No console.errors in production code\n- [ ] All edge cases handled\n\n**Performance:**\n- [ ] Response times within targets\n- [ ] Caching strategy implemented\n- [ ] Database queries optimized\n- [ ] Bundle size impact minimal\n\n**Reliability:**\n- [ ] Error handling comprehensive\n- [ ] Fallback strategies in place\n- [ ] Timeouts configured\n- [ ] Retries implemented where needed\n\n**Documentation:**\n- [ ] PLAN.md updated\n- [ ] API endpoints documented\n- [ ] Performance metrics recorded\n- [ ] Deployment checklist complete\n\n**Testing:**\n- [ ] Type check passing\n- [ ] Lint passing\n- [ ] Build successful\n- [ ] Manual testing complete\n- [ ] Health check verified\n\n---\n\n## üéì Self-Annealing Examples\n\n### Example 1: Redis Null Check\n**Issue:** TypeScript error on `typeof result === 'object'`\n**Fix:** Added `result !== null` check before property access\n**Lesson:** Always check for null before accessing object properties in type guards\n\n### Example 2: Circuit Breaker Integration\n**Issue:** TinyFish failures caused cascading errors\n**Fix:** Wrapped API calls in circuit breaker\n**Impact:** 95% faster error responses, graceful degradation\n**Lesson:** External API failures should not cascade to users\n\n### Example 3: Rate Limiting Cleanup\n**Issue:** In-memory Map grew unbounded\n**Fix:** Added 60-second cleanup interval\n**Impact:** Memory leak prevented\n**Lesson:** Always clean up in-memory data structures\n\n---\n\n## üìö Resources\n\n**Internal:**\n- `PLAN.md` ‚Äî Backend architecture roadmap\n- `AGENTS.md` ‚Äî 3-layer architecture explanation\n- `directives/*.md` ‚Äî Workflow SOPs\n\n**External:**\n- Next.js API Routes: https://nextjs.org/docs/app/building-your-application/routing/route-handlers\n- Vercel Serverless: https://vercel.com/docs/functions/serverless-functions\n- TypeScript Handbook: https://www.typescriptlang.org/docs/handbook/\n\n---\n\n**Version:** 1.0  \n**Last Updated:** 2026-02-16  \n**Status:** Production Template\n\n---\n\n**Remember:** You are the engine. Build it fast, build it reliable, build it scalable. Leave the polish to Design Lead.\nEOF)"
    ]
  }
}
